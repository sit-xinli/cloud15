# AWS マルチティアアーキテクチャドキュメント

## アーキテクチャ概要

このドキュメントでは、本番環境の Web アプリケーション向けに設計された、高可用性マルチティア AWS インフラストラクチャについて説明します。このアーキテクチャは、可用性、セキュリティ、スケーラビリティに関するベストプラクティスを実装しています。

## アーキテクチャ図

![AWS Architecture](architecture.png)

## アーキテクチャコンポーネント

### 1. ネットワークインフラストラクチャ

#### VPC (Virtual Private Cloud)
- **CIDR ブロック**: 10.0.0.0/16
- **DNS 解決**: 有効
- **DNS ホスト名**: 有効
- **目的**: すべてのリソースのための隔離されたネットワーク環境

#### アベイラビリティゾーン
インフラストラクチャは、単一の AWS リージョン内の **2つのアベイラビリティゾーン** にまたがっています:
- **アベイラビリティゾーン A**: プライマリゾーン
- **アベイラビリティゾーン B**: 冗長性のためのセカンダリゾーン

#### サブネット

| サブネット名 | タイプ | CIDR | アベイラビリティゾーン | 目的 |
|-------------|------|------|-------------------|---------|
| パブリックサブネット 1 | パブリック | 10.0.0.0/24 | AZ-A | NAT ゲートウェイ, ALB |
| プライベートサブネット 1 | プライベート | 10.0.1.0/24 | AZ-A | Web インスタンス, RDS プライマリ |
| パブリックサブネット 2 | パブリック | 10.0.2.0/24 | AZ-B | ALB |
| プライベートサブネット 2 | プライベート | 10.0.3.0/24 | AZ-B | Web インスタンス, RDS セカンダリ |

**パブリックサブネット**:
- インターネットゲートウェイへのルートを持つ
- 直接インターネットアクセスが必要なリソースに使用
- NAT ゲートウェイと Application Load Balancer をホスト

**プライベートサブネット**:
- インターネット向けトラフィックを NAT ゲートウェイ経由でルーティング
- 直接のインターネットアクセスから隔離
- アプリケーションインスタンスとデータベースをホスト

#### インターネットゲートウェイ
- VPC にアタッチ
- パブリックサブネットのインターネット接続を有効化
- パブリックサブネット内のリソースがインバウンド/アウトバウンドトラフィックに使用

#### NAT ゲートウェイ
- **場所**: パブリックサブネット 1 (AZ-A)
- **目的**: プライベートサブネットのアウトバウンドインターネットアクセスを提供
- **Elastic IP**: 静的パブリック IP アドレスが必要
- **注記**: コスト最適化のための単一 NAT ゲートウェイ設計。本番環境では、マルチ AZ NAT ゲートウェイを検討してください。

#### ルートテーブル

**パブリックルートテーブル**:
- パブリックサブネットに関連付け (10.0.0.0/24, 10.0.2.0/24)
- ルート:
  - `10.0.0.0/16` → ローカル (VPC)
  - `0.0.0.0/0` → インターネットゲートウェイ

**プライベートルートテーブル**:
- プライベートサブネットに関連付け (10.0.1.0/24, 10.0.3.0/24)
- ルート:
  - `10.0.0.0/16` → ローカル (VPC)
  - `0.0.0.0/0` → NAT ゲートウェイ (AZ-A 内)

### 2. Application Load Balancer (ALB)

- **タイプ**: Application Load Balancer (レイヤー 7)
- **スキーム**: インターネット向け
- **サブネット**: 両方のパブリックサブネット (AZ-A および AZ-B) にデプロイ
- **セキュリティ**: HTTP/HTTPS トラフィックを許可するセキュリティグループで構成
- **ターゲット**: プライベートサブネット内の Auto Scaling Group インスタンス
- **ヘルスチェック**: インスタンスの健全性を監視し、健全なインスタンスにのみトラフィックをルーティング

**主な機能**:
- クロスゾーン負荷分散
- 接続ドレイニング
- スティッキーセッション (必要な場合)
- SSL/TLS ターミネーション
- パスベースまたはホストベースのルーティング

### 3. Auto Scaling Group

- **デプロイ**: 両方のアベイラビリティゾーン (AZ-A および AZ-B) にまたがる
- **サブネット**: プライベートサブネット 1 およびプライベートサブネット 2
- **ターゲット**: Application Load Balancer に登録
- **スケーリング**: メトリクス (CPU、ネットワーク、カスタムメトリクス) に基づく動的スケーリング

**構成**:
- **最小サイズ**: 構成可能 (例: 2 インスタンス)
- **希望する容量**: 構成可能 (例: 2 インスタンス)
- **最大サイズ**: 構成可能 (例: 6 インスタンス)
- **ヘルスチェックタイプ**: ELB ヘルスチェック
- **ヘルスチェック猶予期間**: 300 秒 (一般的)

**Auto Scaling ポリシー**:
- 平均 CPU > 70% でスケールアップ
- 平均 CPU < 30% でスケールダウン
- ターゲット追跡またはステップスケーリングポリシー

### 4. Web アプリケーションインスタンス

- **場所**: プライベートサブネット (AZ-A および AZ-B)
- **起動テンプレート**: インスタンス構成を定義
- **セキュリティグループ**: Web インスタンスセキュリティグループ
- **インスタンスタイプ**: 構成可能 (例: t3.micro, t3.small)
- **AMI**: アプリケーション固有の AMI (Amazon Linux 2, Ubuntu など)

**セキュリティグループルール** (Web インスタンス):
- **インバウンド**:
  - HTTP (80) ALB セキュリティグループから
  - HTTPS (443) ALB セキュリティグループから
  - SSH (22) Bastion/VPN から (オプション)
- **アウトバウンド**:
  - 0.0.0.0/0 へのすべてのトラフィック (更新、外部 API 呼び出し用)

### 5. RDS データベース (マルチ AZ)

- **エンジン**: 構成可能 (MySQL, PostgreSQL など)
- **デプロイ**: 高可用性のためのマルチ AZ
- **プライマリインスタンス**: プライベートサブネット 1 (AZ-A)
- **スタンバイインスタンス**: プライベートサブネット 2 (AZ-B)
- **サブネットグループ**: 両方のプライベートサブネットにまたがる RDS サブネットグループ

**マルチ AZ 機能**:
- スタンバイインスタンスへの自動フェイルオーバー
- 同期レプリケーション
- 手動介入不要
- 単一の DNS エンドポイント (自動フェイルオーバー)

**セキュリティグループ**:
- **RDS プライマリセキュリティグループ** (AZ-A)
- **RDS セカンダリセキュリティグループ** (AZ-B)
- **ルール**:
  - インバウンド: Web インスタンスセキュリティグループからのデータベースポート (例: MySQL の場合は 3306、PostgreSQL の場合は 5432)
  - アウトバウンド: 不要 (データベースはアウトバウンド接続を開始しないため)

**データベース構成**:
- **インスタンスクラス**: 構成可能 (db.t3.micro, db.t3.small など)
- **ストレージ**: 本番ワークロードには GP3 または io1
- **バックアップ**: 自動バックアップ有効
- **バックアップ保持期間**: 7-30 日
- **暗号化**: 保存時の暗号化有効
- **拡張モニタリング**: 有効

### 6. セキュリティグループ

#### Web インスタンスセキュリティグループ
- **目的**: Web アプリケーションインスタンスへのトラフィックを制御
- **インバウンドルール**:
  - ポート 80 (HTTP) ALB セキュリティグループから
  - ポート 443 (HTTPS) ALB セキュリティグループから
- **アウトバウンドルール**:
  - 0.0.0.0/0 へのすべてのトラフィック (NAT ゲートウェイ経由のインターネットアクセス)
  - RDS セキュリティグループへのデータベースポート

#### ALB セキュリティグループ
- **目的**: Application Load Balancer へのトラフィックを制御
- **インバウンドルール**:
  - ポート 80 (HTTP) 0.0.0.0/0 から
  - ポート 443 (HTTPS) 0.0.0.0/0 から
- **アウトバウンドルール**:
  - ポート 80 Web インスタンスセキュリティグループへ
  - ポート 443 Web インスタンスセキュリティグループへ

#### RDS セキュリティグループ
- **目的**: データベースインスタンスへのトラフィックを制御
- **インバウンドルール**:
  - データベースポート (例: 3306, 5432) Web インスタンスセキュリティグループから
- **アウトバウンドルール**:
  - なし

## トラフィックフロー

### インバウンドトラフィック (ユーザーリクエスト)
1. ユーザーリクエストが **インターネットゲートウェイ** に到着
2. トラフィックはパブリックサブネット内の **Application Load Balancer** にルーティング
3. ALB はヘルスチェックを実行し、健全なターゲットを選択
4. リクエストはプライベートサブネット (AZ-A または AZ-B) 内の **Web インスタンス** に転送
5. Web インスタンスがリクエストを処理
6. データベースアクセスが必要な場合、Web インスタンスは **RDS エンドポイント** に接続
7. レスポンスは同じパスを通って戻る

### アウトバウンドトラフィック (インスタンス更新、API 呼び出し)
1. プライベートサブネット内の Web インスタンスがアウトバウンドリクエストを開始
2. トラフィックはパブリックサブネット 1 内の **NAT ゲートウェイ** にルーティング
3. NAT ゲートウェイは **インターネットゲートウェイ** 経由でトラフィックを転送
4. レスポンスは NAT ゲートウェイを通って Web インスタンスに戻る

### データベースレプリケーション (マルチ AZ)
1. 書き込み操作は **RDS プライマリ** (AZ-A) に送信
2. データは **RDS スタンバイ** (AZ-B) に同期的にレプリケート
3. スタンバイは自動フェイルオーバーの準備ができている状態を維持
4. 単一の DNS エンドポイントが自動的にアクティブなインスタンスを指す

## 高可用性設計

### アベイラビリティゾーンの冗長性
- すべてのティアが2つの AZ にまたがってデプロイ
- 単一の AZ の障害がアプリケーションの可用性に影響を与えない
- Auto Scaling は健全な AZ 全体で希望する容量を維持

### データベースフェイルオーバー
- マルチ AZ RDS は自動フェイルオーバーを提供
- 一般的なフェイルオーバー時間: 60-120 秒
- 同期レプリケーションによるデータ損失なし
- アプリケーションは同じエンドポイントを使用して自動的に再接続

### ロードバランサーヘルスチェック
- インスタンスの健全性の継続的な監視
- 異常なインスタンスはローテーションから除外
- Auto Scaling は代替インスタンスを起動
- インスタンス障害時のダウンタイムゼロ

## セキュリティに関する考慮事項

### ネットワーク分離
- **パブリック/プライベートサブネットの分離**: アプリケーションとデータベース層はプライベートサブネットに隔離
- **直接のインターネットアクセスなし**: プライベートリソースは NAT ゲートウェイ経由でのみインターネットにアクセス
- **セキュリティグループによるセグメンテーション**: 各層には必要最小限のアクセスのみ許可する専用のセキュリティグループ

### 暗号化
- **転送中**: ALB とアプリケーション通信に HTTPS/TLS を使用
- **保存時**: RDS 暗号化を有効化
- **シークレット**: 認証情報には AWS Secrets Manager または Parameter Store を使用

### アクセス制御
- **IAM ロール**: AWS サービスアクセスにインスタンスプロファイルを使用
- **ハードコードされた認証情報なし**: IAM ロールとシークレット管理を使用
- **最小権限**: セキュリティグループは必要なポート/プロトコルのみ許可

## スケーラビリティ

### 水平スケーリング
- Auto Scaling Group は自動的にインスタンスを追加/削除
- ロードバランサーはすべての健全なインスタンスにトラフィックを分散
- シームレスなスケーリングのためにステートレスアプリケーション設計を推奨

### データベーススケーリング
- **垂直スケーリング**: CPU/メモリを増やすために RDS インスタンスクラスをアップグレード
- **リードレプリカ**: 読み取り負荷の高いワークロード用にリードレプリカを追加
- **接続プーリング**: 大規模環境での接続管理に RDS Proxy を使用

## コスト最適化の考慮事項

### 現在の設計
- 単一の NAT ゲートウェイ (AZ ごとに1つではなく)
- 需要に合わせて容量を調整する Auto Scaling

### 推奨事項
- 予測可能なベースラインにはリザーブドインスタンスまたは Savings Plans を使用
- RDS ストレージの自動スケーリングを有効化
- 変動するワークロードには Aurora Serverless を検討
- CloudWatch メトリクスを使用してインスタンスサイズを適正化

## 災害復旧

### バックアップ戦略
- **RDS 自動バックアップ**: ポイントインタイムリカバリによる毎日のスナップショット
- **スナップショット保持期間**: 7-30 日
- **クロスリージョンレプリケーション**: 災害復旧のために検討

### 目標復旧
- **RTO (目標復旧時間)**: 〜2-5 分 (自動マルチ AZ フェイルオーバー)
- **RPO (目標復旧時点)**: 〜0 秒 (同期レプリケーション)

## 監視とロギング

### CloudWatch メトリクス
- ALB メトリクス: リクエスト数、レイテンシ、健全なホスト数
- Auto Scaling メトリクス: CPU 使用率、ネットワークトラフィック
- RDS メトリクス: CPU、IOPS、接続数、レプリケーションラグ

### ロギング
- **VPC フローログ**: ネットワークトラフィック分析
- **ALB アクセスログ**: リクエストレベルのロギング
- **RDS ログ**: エラーログ、スロークエリログ
- **CloudTrail**: API アクティビティロギング

## 将来の拡張

1. アプリケーション層の保護のために ALB に **WAF (Web Application Firewall)** を追加
2. より高い可用性のために **AZ-B に NAT ゲートウェイ** をデプロイ
3. 安全なインスタンスアクセスのために **Bastion Host** または **AWS Systems Manager Session Manager** を追加
4. 静的コンテンツ配信のために **CloudFront CDN** を実装
5. アプリケーションキャッシング層のために **ElastiCache** を追加
6. 読み取りスケーリングのために **RDS リードレプリカ** を構成
7. 一元化されたバックアップ管理のために **AWS Backup** を実装
8. DNS フェイルオーバーのために **Route53 ヘルスチェック** を追加
